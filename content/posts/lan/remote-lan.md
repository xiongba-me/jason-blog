---
date: '2024-07-01T21:40:06+08:00'
draft: false
title: 'å®¶åº­å†…ç½‘å®‰å…¨è®¿é—®'
tags: ['å†…ç½‘', 'shadowsocks', 'Cloudflare']
categories: ["å†…ç½‘"]
description: "æ‰“é€ å®¶åº­å†…ç½‘çš„å®‰å…¨è®¿é—®"
---

## ğŸ¯ é¡¹ç›®ç›®æ ‡

- **è¿œç¨‹æ¡Œé¢è¿æ¥** - èƒ½é€šè¿‡è¿œç¨‹è¿æ¥ï¼ˆæ¡Œé¢ï¼‰å®¶åº­å±€åŸŸç½‘ä¸­çš„ä¸»æœºï¼Œæ”¯æŒ Mac å’Œ Windows ç³»ç»Ÿ
- **å†…ç½‘æœåŠ¡è®¿é—®** - å±€åŸŸç½‘å†…ä¸»æœºå®‰è£…äº†å¤šç§åº”ç”¨æœåŠ¡ï¼Œå¦‚æ•°æ®åº“ã€æ–‡ä»¶ä¸‹è½½ã€NAS äº‘ç›˜ç­‰ï¼Œéœ€è¦å¤–éƒ¨å®‰å…¨è®¿é—®
- **å®‰å…¨æ€§ä¿éšœ** - ä¸é€šè¿‡ç«¯å£æ˜ å°„æ–¹å¼ç›´æ¥æš´éœ²å„ç«¯å£åˆ°å…¬ç½‘ï¼Œç¡®ä¿å†…ç½‘å®‰å…¨

## âœ¨ æŠ€æœ¯ç‰¹ç‚¹

- ğŸ—ï¸ **æ··åˆæ¶æ„** - å…¬ç½‘æœåŠ¡ç›´è¿ + å†…ç½‘æœåŠ¡ä»£ç†
- ğŸ§  **æ™ºèƒ½é€‰æ‹©** - è‡ªåŠ¨æµ‹è¯•å»¶è¿Ÿé€‰æ‹©æœ€ä¼˜èŠ‚ç‚¹
- ğŸ” **å®‰å…¨åŠ å¯†** - ä½¿ç”¨å†›ç”¨çº§ xchacha20 åŠ å¯†ç®—æ³•
- ğŸŒ **ç¨³å®šè¿æ¥** - Cloudflare åŠ¨æ€åŸŸåç¡®ä¿é«˜å¯ç”¨æ€§

## ğŸš€ åº”ç”¨åœºæ™¯

- ğŸ’¼ **è¿œç¨‹åŠå…¬** - è®¿é—®å…¬å¸å†…ç½‘èµ„æº
- ğŸ  **å®¶åº­ç½‘ç»œ** - è¿œç¨‹ç®¡ç†å®¶åº­è®¾å¤‡
- â˜ï¸ **æ··åˆäº‘æœåŠ¡** - æ„å»ºç§æœ‰äº‘æ¶æ„
- ğŸ› ï¸ **å¼€å‘ç¯å¢ƒ** - è¿œç¨‹è°ƒè¯•å’Œå¼€å‘

## ğŸ“Š ç½‘ç»œæ‹“æ‰‘
ä¸‹å›¾å±•ç¤ºäº†å®Œæ•´çš„ç½‘ç»œæ¶æ„è®¾è®¡ï¼š
```mermaid
graph TD
    A[å¼€å§‹] --> B(ç»“æŸ)
```
```mermaid
graph TB
    subgraph "å¤–ç½‘ç¯å¢ƒ"
        Internet[äº’è”ç½‘]
        CF[Cloudflare DNS<br/>123456.xyz]
        Client[å®¢æˆ·ç«¯è®¾å¤‡<br/>è¿è¡Œ Clash]
    end
    
    subgraph "å®¶åº­å†…ç½‘ 192.168.x.0/24"
        Router[ImmortalWrt è·¯ç”±å™¨<br/>Newifi D1<br/>192.168.x.1]
        NAS[é»‘ç¾¤æ™– NAS<br/>DS3617xs<br/>192.168.x.2]
        Mac[Mac ä¸»æœº<br/>192.168.x.x]
        Win[Windows ä¸»æœº<br/>192.168.x.x]
        Services[å†…ç½‘æœåŠ¡<br/>æ•°æ®åº“/ä¸‹è½½/äº‘ç›˜ç­‰]
    end
    
    subgraph "NAS å®¹å™¨æœåŠ¡"
        SS[Shadowsocks-libev<br/>ç«¯å£ 8888]
        Nginx[Nginx åå‘ä»£ç†]
        DDNS[DDNS æœåŠ¡<br/>æ›´æ–°åŠ¨æ€ IP]
    end
    
    %% å¤–ç½‘è¿æ¥
    Internet --> CF
    Client --> CF
    CF --> Router
    
    %% è·¯ç”±å™¨è¿æ¥
    Router --> NAS
    Router --> Mac
    Router --> Win
    
    %% NAS å†…éƒ¨æœåŠ¡
    NAS --> SS
    NAS --> Nginx
    NAS --> DDNS
    NAS --> Services
    
    %% ä»£ç†è®¿é—®è·¯å¾„
    Client -.-> SS
    SS -.-> Services
    
    %% åå‘ä»£ç†
    Nginx --> Router
    
    %% DDNS æ›´æ–°
    DDNS --> CF
    
    %% ç«¯å£è½¬å‘
    Router --> SS
    
```
## ğŸ› ï¸ ç¡¬ä»¶ & è½¯ä»¶æ¸…å•

### ğŸ’» ä¸»è¦è®¾å¤‡

- **ğŸ“¶ ä¸»è·¯ç”±å™¨** - ä¸€å°åˆ·äº† ImmortalWrt çš„ Newifi D1 è·¯ç”±å™¨
  - åŠŸèƒ½ï¼šä¸»è·¯ç”±ã€ç«¯å£è½¬å‘ã€DHCP åˆ†é…å†…ç½‘ IP
  
- **ğŸ’¾ NAS æœåŠ¡å™¨** - ä¸€å°æ˜Ÿé™…èœ—ç‰›é»‘ç¾¤æ™– NAS
  - ç‰ˆæœ¬ï¼šDS3617xs
  - æœåŠ¡ï¼šDockerã€Shadowsocks-libevã€Nginx åå‘ä»£ç†ã€DDNS æœåŠ¡

### ğŸŒ ç½‘ç»œæœåŠ¡

- **ğŸ“œ åŸŸåæœåŠ¡** - å‡†å¤‡ä¸€ä¸ªåŸŸåï¼ˆç¤ºä¾‹ï¼š123456.xyzï¼‰
  - æ‰˜ç®¡å¹³å°ï¼šCloudflare
  - ç”¨é€”ï¼šDNS è§£æå’ŒåŠ¨æ€åŸŸåç®¡ç†
  
- **ğŸ”„ å®¢æˆ·ç«¯è½¯ä»¶** - Clash ä»£ç†å®¢æˆ·ç«¯
  - åŠŸèƒ½ï¼šè®¿é—® SS æœåŠ¡ã€è®¾ç½®ä»£ç†ç»„ã€URL èŠ‚ç‚¹æµ‹è¯•
  - ä¿éšœï¼šè®¿é—®å†…ç½‘çš„å®‰å…¨æ€§

## ğŸš€ å®æ–½æ­¥éª¤

### 1ï¸âƒ£ å®‰è£…è·¯ç”±å™¨ç³»ç»Ÿ

#### ğŸ“¥ å›ºä»¶ä¸‹è½½ä¸åˆ·æœº
- **ä¸‹è½½å›ºä»¶** - ä» [ImmortalWrtåœ°å€](https://firmware-selector.immortalwrt.org/) ä¸‹è½½ç¬¦åˆç¡¬ä»¶çš„å›ºä»¶
  ![å›ºä»¶ä¸‹è½½](/images/post/lan/immortalWrt.png)
  
- **åˆ·æœºæµç¨‹** - å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡åˆ·æœºï¼Œè¯·æŒ‰ä»¥ä¸‹æ­¥éª¤æ“ä½œï¼š
  1. å°†è·¯ç”±å™¨æ¢å¤å‡ºå‚è®¾ç½®
  2. å…ˆå®‰è£… Kernel é•œåƒ
  3. è¿›å…¥ç³»ç»Ÿåï¼ŒæŒ‰æç¤ºå®‰è£… Sysupgrade é•œåƒ

### 2ï¸âƒ£ è·¯ç”±å™¨åŸºç¡€é…ç½®

#### ğŸ’¾ å­˜å‚¨æ‰©å®¹è®¾ç½®
> âš ï¸ **é‡è¦æç¤º**ï¼šå¿…é¡»å…ˆå®Œæˆå­˜å‚¨æ‰©å®¹ï¼Œå¦åˆ™åç»­è®¾ç½®ä¼šå¤±æ•ˆ

- **SDå¡é…ç½®** - æ’å…¥ 16G SDå¡ï¼Œåˆ†é…å­˜å‚¨ç©ºé—´ï¼š
  - `1G` â†’ `/overlay` ï¼ˆç³»ç»Ÿç©ºé—´ã€è½¯ä»¶åŒ…å®‰è£…ï¼‰
  - `å‰©ä½™ç©ºé—´` â†’ `/workspace` ï¼ˆæ—¥å¸¸ä½¿ç”¨ã€File Browserç­‰ï¼‰
  
- **å‚è€ƒæ–‡æ¡£** - [æŒ‚è½½ç‚¹SDå¡æ‰©å®¹](https://doc.embedfire.com/openwrt/user_manal/zh/latest/User_Manual/openwrt/storage.html)
  
- **é…ç½®æ•ˆæœ**ï¼š
  ![æŒ‚è½½ç‚¹](/images/post/lan/mounts.jpg)

#### ğŸŒ ç½‘ç»œæ¥å£é…ç½®

**LAN å£è®¾ç½®**ï¼š
- è·¯å¾„ï¼š`ç½‘ç»œ > æ¥å£ > lan > ç¼–è¾‘`
- IPv4 åœ°å€ï¼š`192.168.x.1` ï¼ˆä¸»è·¯ç”±åœ°å€ï¼‰
- DHCP èµ·å§‹ï¼š`50` ï¼ˆå®¢æˆ·ç«¯åœ°å€ä» 192.168.x.50 å¼€å§‹ï¼‰

**WAN å£è®¾ç½®**ï¼š
- è·¯å¾„ï¼š`ç½‘ç»œ > æ¥å£ > wan > ç¼–è¾‘`
- è¿æ¥æ–¹å¼ï¼š`PPPoE` è¾“å…¥å®½å¸¦è´¦å·å¯†ç 

#### ğŸ  é™æ€IPåˆ†é…
- **æ·»åŠ é™æ€ç§Ÿçº¦**ï¼š`çŠ¶æ€ > æ¦‚è§ˆ > å·²åˆ†é…çš„ DHCP ç§Ÿçº¦ > é™æ€ç§Ÿçº¦`
- **è®¾ç½®é™æ€IP**ï¼š`ç½‘ç»œ > DHCP/DNS > é™æ€IPåœ°å€åˆ†é…`
- **ç¤ºä¾‹é…ç½®**ï¼šå°†å®‰è£… SS çš„ä¸»æœº IP è®¾ç½®ä¸º `192.168.x.2`

#### ğŸ”„ ç«¯å£è½¬å‘é…ç½®
- **é…ç½®è·¯å¾„**ï¼š`ç½‘ç»œ > é˜²ç«å¢™ > ç«¯å£è½¬å‘`
- **æ·»åŠ è§„åˆ™**ï¼šWAN ç«¯å£ `8888` â†’ å†…ç½‘ `192.168.x.2:8888`

#### ğŸŒ æœ¬åœ°åŸŸåè§£æ
- **é…ç½®è·¯å¾„**ï¼š`ç½‘ç»œ > DHCP/DNS > å¸¸è§„`
- **æ·»åŠ è§£æ**ï¼š`/123456.xyz/192.168.x.2`
- **ä½œç”¨**ï¼šå°†åŸŸå `123456.xyz` æŒ‡å‘å†…ç½‘ `192.168.x.2`

### 3ï¸âƒ£ NAS æœåŠ¡é…ç½®

#### âš¡ DDNS åŠ¨æ€è§£æ
- **æ‰§è¡Œè®¾å¤‡**ï¼šä½¿ç”¨ NAS è®¡åˆ’ä»»åŠ¡ï¼ˆNewifi D1 æ€§èƒ½æœ‰é™ï¼‰
- **åŠŸèƒ½**ï¼šåŠ¨æ€ IP é…ç½®åˆ° Cloudflare

#### ğŸ³ Docker å®¹å™¨éƒ¨ç½²
- **é•œåƒè·å–**ï¼šé»‘ç¾¤æ™–éœ€é€šè¿‡é•œåƒç«™ä¸‹è½½åä¸Šä¼ 
- **å®¹å™¨æœåŠ¡**ï¼šå®‰è£… shadowsocks-libev

#### ğŸ” Shadowsocks é…ç½®
- **ç«¯å£è®¾ç½®**ï¼š`8888` ï¼ˆä¸è·¯ç”±å™¨ç«¯å£è½¬å‘ä¸€è‡´ï¼‰
- **å¯†ç ç”Ÿæˆ**ï¼šä½¿ç”¨ [UUIDç”Ÿæˆå™¨](https://www.uuidgenerator.net/)
- **åŠ å¯†æ–¹å¼**ï¼š`xchacha20-ietf-poly1305`

#### ğŸ”„ Nginx åå‘ä»£ç†
- **é…ç½®è·¯å¾„**ï¼š`æ§åˆ¶é¢æ¿ > åº”ç”¨ç¨‹åºé—¨æˆ· > åå‘ä»£ç†æœåŠ¡å™¨`
- **ä»£ç†è§„åˆ™**ï¼š`x.123456.xyz:80` â†’ `192.168.x.1:80`
- **è®¿é—®æ–¹å¼**ï¼šé€šè¿‡ `http://x.123456.xyz` è®¿é—®è·¯ç”±å™¨

### 4ï¸âƒ£ Clash å®¢æˆ·ç«¯é…ç½®

åœ¨åŸæœ‰é…ç½®æ–‡ä»¶åŸºç¡€ä¸Šï¼Œæ·»åŠ ä»¥ä¸‹èŠ‚ç‚¹é…ç½®

```
# Clash ä»£ç†é…ç½®æ–‡ä»¶
proxies:
  - name: 123456-ss                          # ä»£ç†èŠ‚ç‚¹åç§°ï¼Œç”¨äºåç»­å¼•ç”¨
    type: ss                                 # ä½¿ç”¨ Shadowsocks åè®®
    server: åŠ¨æ€åŸŸå.123456.xyz              # ä»£ç†æœåŠ¡å™¨åœ°å€ï¼Œé€šè¿‡ Cloudflare åŠ¨æ€è§£æ
    port: 8888                               # ä»£ç†æœåŠ¡å™¨ç«¯å£
    cipher: xchacha20-ietf-poly1305          # åŠ å¯†ç®—æ³•ï¼Œæä¾›é«˜å¼ºåº¦å®‰å…¨ä¿æŠ¤
    password: password                       # è¿æ¥è®¤è¯å¯†ç 
    udp: true                                # å¯ç”¨ UDP è½¬å‘ï¼Œæ”¯æŒ DNS æŸ¥è¯¢ç­‰

proxy-groups:
  - name: 123456-net                         # ä»£ç†ç»„åç§°
    type: url-test                           # è‡ªåŠ¨æµ‹è¯•å»¶è¿Ÿé€‰æ‹©æœ€å¿«èŠ‚ç‚¹
    proxies:
      - 123456-ss                            # åŒ…å«ä¸Šé¢å®šä¹‰çš„ä»£ç†èŠ‚ç‚¹
    url: 123456.xyz                          # æµ‹è¯•è¿é€šæ€§çš„ç›®æ ‡åœ°å€
    interval: 300                            # æ¯ 300 ç§’æµ‹è¯•ä¸€æ¬¡å»¶è¿Ÿ

rules:
  - DOMAIN,www.123456.xyz,DIRECT             # www å­åŸŸåç›´è¿ï¼Œç”¨äºå…¬å¼€åšå®¢è®¿é—®
  - DOMAIN-SUFFIX,123456.xyz,123456-net      # å…¶ä»– .123456.xyz åŸŸåèµ°ä»£ç†ï¼Œè®¿é—®å†…ç½‘æœåŠ¡
  - MATCH,DIRECT                             # å…¶ä»–æ‰€æœ‰æµé‡ç›´è¿ï¼Œæ­£å¸¸ä¸Šç½‘
```
## ğŸ”§ é«˜çº§ä½¿ç”¨æŠ€å·§

### ğŸš€ SSH éš§é“ç«¯å£è½¬å‘

é€šè¿‡ Shadowsocks è¿æ¥åˆ°å†…ç½‘åï¼Œä¸»è·¯ç”±å™¨å˜æˆè·³æ¿æœºã€‚åˆ©ç”¨ SSH éš§é“æŠ€æœ¯ï¼Œå°†å†…ç½‘è®¾å¤‡ç«¯å£æ˜ å°„åˆ°æœ¬åœ°ï¼Œå®ç°çµæ´»çš„å†…ç½‘æœåŠ¡è®¿é—®ã€‚

#### ğŸ’¡ åŸºæœ¬åŸç†
- **ğŸ—ï¸ è·³æ¿æœºåˆ¶** - SS è¿æ¥åï¼Œè·¯ç”±å™¨æˆä¸ºè®¿é—®å†…ç½‘çš„æ¡¥æ¢
- **ğŸ”„ ç«¯å£è½¬å‘** - é€šè¿‡ SSH éš§é“å°†è¿œç¨‹ç«¯å£æ˜ å°„åˆ°æœ¬åœ°ç«¯å£  
- **ğŸ‘» é€æ˜è®¿é—®** - æœ¬åœ°åº”ç”¨åƒè®¿é—®æœ¬åœ°æœåŠ¡ä¸€æ ·è®¿é—®å†…ç½‘æœåŠ¡

#### ğŸ“ å‘½ä»¤æ ¼å¼
```
ssh -N -L æœ¬åœ°ç«¯å£:ç›®æ ‡IP:ç›®æ ‡ç«¯å£ ç”¨æˆ·@è·³æ¿æœºåœ°å€
```

#### ğŸ¯ å®é™…ä½¿ç”¨ç¤ºä¾‹

**å¤šç«¯å£æ˜ å°„**ï¼š
```
# æ˜ å°„å†…ç½‘å¤šä¸ªæœåŠ¡ç«¯å£åˆ°æœ¬åœ°
ssh -N -L 1234:192.168.x.x:1234 -L 5678:192.168.x.x:5678 root@root.123456.xyz
```

**å‚æ•°è¯¦è§£**ï¼š
- `-N` - ä¸æ‰§è¡Œè¿œç¨‹å‘½ä»¤ï¼Œä»…å»ºç«‹éš§é“
- `-L 1234:192.168.x.x:1234` - æœ¬åœ° 1234 ç«¯å£è½¬å‘åˆ°å†…ç½‘è®¾å¤‡ 1234 ç«¯å£
- `-L 5678:192.168.x.x:5678` - åŒæ—¶æ˜ å°„å¤šä¸ªç«¯å£
- `root@root.123456.xyz` - é€šè¿‡è·¯ç”±å™¨åŸŸåä»¥ root ç”¨æˆ·è¿æ¥

#### ğŸ“± å®ç”¨åœºæ™¯ç¤ºä¾‹

**æ•°æ®åº“è®¿é—®**ï¼š
```
# éš§é“å»ºç«‹
# æœ¬åœ°è¿æ¥
mysql -h 127.0.0.1 -P 3306
```

**Web æœåŠ¡è®¿é—®**ï¼š
```
# éš§é“å»ºç«‹  
# æµè§ˆå™¨è®¿é—®
http://127.0.0.1:8080
```

**è¿œç¨‹æ¡Œé¢è¿æ¥**ï¼š
```
# éš§é“å»ºç«‹
# RDP è¿æ¥
127.0.0.1:3389
```

> ğŸ’¡ **ä½¿ç”¨æç¤º**ï¼šå»ºç«‹éš§é“åï¼Œé€šè¿‡ `127.0.0.1:ç«¯å£å·` è®¿é—®å†…ç½‘æœåŠ¡ï¼Œå°±åƒè¿™äº›æœåŠ¡è¿è¡Œåœ¨æœ¬åœ°ä¸€æ ·æ–¹ä¾¿ï¼
