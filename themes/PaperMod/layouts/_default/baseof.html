{{- if lt hugo.Version "0.146.0" }}
{{- errorf "=> hugo v0.146.0 or greater is required for hugo-PaperMod to build " }}
{{- end -}}

<!DOCTYPE html>
<html lang="{{ site.Language }}" dir="{{ .Language.LanguageDirection | default "auto" }}">

<head>
    {{- partial "head.html" . }}
</head>

<body class="
{{- if (or (ne .Kind `page` ) (eq .Layout `archives`) (eq .Layout `search`)) -}}
{{- print "list" -}}
{{- end -}}
{{- if eq site.Params.defaultTheme `dark` -}}
{{- print " dark" }}
{{- end -}}
" id="top">
    {{- partialCached "header.html" . .Page -}}
    <main class="main">
        {{- block "main" . }}{{ end }}
    </main>
{{ if .Store.Get "hasMermaid" }}
   <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <script>
document.addEventListener('DOMContentLoaded', function() {
    
    // 检查 Mermaid 是否加载
    if (typeof mermaid === 'undefined') {
        console.error("Mermaid 库未加载。请检查 CDN 路径。");
        return;
    }
    
    // 首次加载时初始化（手动控制渲染）
    mermaid.initialize({ startOnLoad: false }); 
    
    // -----------------------------------------------------
    // 核心渲染函数：手动处理所有图表
    // -----------------------------------------------------
    function renderMermaidCharts() {
        // 使用精确的选择器，只查找文章内容容器内的 Mermaid 元素
        const chartElements = document.querySelectorAll('.post-content pre.mermaid, .article-entry pre.mermaid');
        
        chartElements.forEach((element, index) => {
            // 检查图表是否已经被渲染过了 (避免重复渲染)
            if (element.getAttribute('data-rendered')) {
                // 如果已渲染，则跳过，等待主题切换时由 updateMermaidTheme() 处理
                return;
            }

            // 1. 提取 Mermaid 原始代码
            const code = element.textContent.trim();
            console.log("正在处理 Mermaid 图表：", code);
            if (!code) return; // 跳过空元素

            // 2. 创建唯一的 ID 和目标容器
            const chartId = 'mermaid-chart-' + index + '-' + Date.now();
            const svgContainer = document.createElement('div');
            svgContainer.id = chartId;
            svgContainer.classList.add('mermaid-svg-container');

            // 3. 异步渲染图表
            // mermaid.render(id, code) 会返回一个 Promise
            mermaid.render(chartId, code)
                .then(({ svg, bindFunctions }) => {
                    // 4. 替换原始代码块为渲染出的 SVG
                    element.innerHTML = svg;
                    element.classList.add('mermaid-rendered');
                    element.setAttribute('data-rendered', 'true');
                    
                    // 绑定事件（如果图表有交互）
                    if (bindFunctions) bindFunctions(element);
                })
                .catch(error => {
                    // 捕获 Promise 错误，打印并防止影响其他代码
                    console.error("Mermaid 渲染错误 (ID:", chartId, "):", error);
                });
        });
    }

    // -----------------------------------------------------
    // 主题切换函数：只负责重新配置和重新运行渲染
    // -----------------------------------------------------
    function updateMermaidTheme() {
        // 1. 确定新主题
        const isDark = document.body.classList.contains('dark');
        // 使用 'dark' 和 'default' 内置主题
        const newTheme = isDark ? 'dark' : 'default'; 
        console.log("更新 Mermaid 主题：" + newTheme);

        // 2. 重新初始化（应用新主题配置）
        const config = {
            startOnLoad: false,
            theme: newTheme 
        };
        mermaid.initialize(config);
        
        // 3. 强制重新渲染已渲染的图表
        document.querySelectorAll('.post-content .mermaid[data-rendered], .article-entry .mermaid[data-rendered]').forEach(element => {
            // 移除 data-rendered 标志和旧的 SVG
            const code = element.textContent.trim();
        console.log("更新 Mermaid 主题：" + code);
            if (!code) return;

            // 重新创建一个容器 ID (每次重新渲染都必须是新的 ID)
            const chartId = 'mermaid-re-render-' + Date.now();

            // 手动渲染，替换旧的 SVG
            mermaid.render(chartId, code)
                .then(({ svg }) => {
                    element.innerHTML = svg;
                })
                .catch(error => {
                    console.error("Mermaid 重新渲染主题时失败：", error);
                });
        });
    }

    // -----------------------------------------------------
    // 初始化和监听
    // -----------------------------------------------------
    
    // 首次加载时，渲染所有图表
    renderMermaidCharts();

    // 监听 body class 变化 (主题切换)
    const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                updateMermaidTheme();
            }
        });
    });
    
    // 观察 document.body 的 class 属性变化
    observer.observe(document.body, {
        attributes: true,
        attributeFilter: ['class']
    });
});
    </script>
{{ end }}
    {{ partialCached "footer.html" . .Layout .Kind (.Param "hideFooter") (.Param "ShowCodeCopyButtons") -}}
</body>
</html>
